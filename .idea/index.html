<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Journal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Mandatory Platform Variables) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let authAttempted = false; // Flag to track if sign-in was attempted

        // --- UTILITY FUNCTIONS ---
        
        /** Shows a message to the user instead of alert() */
        function showMessage(message, isError = false) {
            const container = document.getElementById('message-container');
            container.textContent = message;
            container.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            container.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-800' : 'text-green-800');
            setTimeout(() => {
                container.classList.add('hidden');
            }, 4000);
        }

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function attemptSignIn() {
             try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
                showMessage("Authentication failed. Check console for details.", true);
                document.getElementById('user-id-display').textContent = `User ID: Auth Failed`;
            }
        }

        async function initializeFirebase() {
            if (!firebaseConfig) {
                showMessage("Firebase configuration is missing. Cannot initialize.", true);
                document.getElementById('user-id-display').textContent = `User ID: Config Missing`;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 
                
                // 1. Set up Auth State Listener first
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authentication Successful. User ID:", userId);
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        showMessage("Authentication successful. Memories loading...");
                        setupRealtimeListener();
                    } else {
                        // This block executes if sign-in attempt fails or user logs out.
                        userId = null;
                        document.getElementById('user-id-display').textContent = `User ID: Not Signed In`;
                    }
                });
                
                // 2. Attempt Sign In
                await attemptSignIn();


            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage("Failed to initialize the app. Check console for details.", true);
            }
        }

        // --- FIRESTORE CRUD OPERATIONS ---

        const MEMORY_COLLECTION = 'memories';

        /**
         * Gets the collection reference path for the current user's memories (Private Data).
         */
        function getCollectionRef() {
            if (!userId) throw new Error("User not authenticated.");
            // Private path structure: /artifacts/{appId}/users/{userId}/memories
            return collection(db, `artifacts/${appId}/users/${userId}/${MEMORY_COLLECTION}`);
        }

        /**
         * Adds a new memory entry to Firestore.
         */
        window.addMemory = async function() {
            const titleInput = document.getElementById('memory-title');
            const descInput = document.getElementById('memory-description');
            
            const title = titleInput.value.trim();
            const description = descInput.value.trim();

            if (!userId) {
                showMessage("Authentication required to add a memory.", true);
                return;
            }

            // Simple validation mimicking the Java Controller logic
            if (title.length < 3) {
                showMessage("Invalid Memory Entry: Title must be at least 3 characters long.", true);
                return;
            }
            if (description.length < 5) {
                showMessage("Invalid Memory Entry: Description must be at least 5 characters long.", true);
                return;
            }

            try {
                await addDoc(getCollectionRef(), {
                    title: title,
                    description: description,
                    timestamp: serverTimestamp()
                });
                showMessage("Memory added successfully!");
                titleInput.value = '';
                descInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to add memory. Check console.", true);
            }
        }

        /**
         * Deletes a memory entry from Firestore.
         */
        window.deleteMemory = async function(memoryId) {
            if (!userId) {
                showMessage("Authentication required to delete a memory.", true);
                return;
            }
            
            try {
                // Get the document reference
                const docRef = doc(getCollectionRef(), memoryId);
                await deleteDoc(docRef);
                showMessage("Memory deleted successfully.");
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("Failed to delete memory. Check console.", true);
            }
        }

        // --- REAL-TIME LISTENER (Read Operation) ---

        function setupRealtimeListener() {
            if (!db || !userId) return;

            // Set up a query to listen for all memories for the current user, ordered by time
            const q = query(getCollectionRef());

            onSnapshot(q, (snapshot) => {
                const memoriesList = document.getElementById('memories-list');
                memoriesList.innerHTML = ''; // Clear existing list

                if (snapshot.empty) {
                    memoriesList.innerHTML = '<p class="text-gray-500 italic">No memories stored yet. Add one above!</p>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm mb-3 border-l-4 border-amber-500 transition hover:shadow-md';
                    listItem.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-lg font-semibold text-gray-800">${data.title}</p>
                            <p class="text-sm text-gray-600 truncate">${data.description}</p>
                        </div>
                        <div class="ml-4 flex items-center space-x-2">
                            <span class="text-xs text-gray-400">${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'N/A'}</span>
                            <button onclick="deleteMemory('${doc.id}')" 
                                    class="p-2 rounded-full text-white bg-red-500 hover:bg-red-600 transition duration-150 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.723-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    memoriesList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Firestore real-time listener failed:", error);
                showMessage("Error fetching memories: " + error.message, true);
            });
        }
        
        // --- START APPLICATION ---
        initializeFirebase();

    </script>
    <style>
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-amber-800 tracking-tight flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mr-3 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-8.664 4.144a1 1 0 00.58 1.12l4.75 2.5a1 1 0 00.835 0l4.75-2.5a1 1 0 00.58-1.12L16.276 8H3.724l-.06 6.144zM10 18a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                </svg>
                Memory Journal
            </h1>
            <p id="user-id-display" class="text-xs mt-2 text-gray-500 break-all">Authenticating...</p>
        </header>

        <!-- Message Box -->
        <div id="message-container" class="hidden p-3 mb-6 rounded-lg font-medium text-sm transition duration-300 shadow-lg" role="alert">
            <!-- Messages (Success/Error) will appear here -->
        </div>
        
        <!-- Add New Memory Card -->
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl mb-10 border-t-4 border-amber-500">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Store a New Memory</h2>
            <div class="space-y-4">
                
                <!-- Title Input -->
                <div>
                    <label for="memory-title" class="block text-sm font-medium text-gray-600">Title (e.g., "Birthday Party 2024")</label>
                    <input type="text" id="memory-title" placeholder="Short summary of the memory"
                           class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 transition duration-150" required>
                </div>

                <!-- Description Input -->
                <div>
                    <label for="memory-description" class="block text-sm font-medium text-gray-600">Details (Description)</label>
                    <textarea id="memory-description" rows="3" placeholder="Describe the memory in detail"
                              class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 transition duration-150" required></textarea>
                </div>

                <!-- Add Button -->
                <button onclick="addMemory()"
                        class="w-full sm:w-auto px-6 py-3 bg-amber-600 text-white font-semibold rounded-lg shadow-lg hover:bg-amber-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-amber-500 focus:ring-opacity-50">
                    Add Memory Entry (Create)
                </button>
            </div>
        </div>

        <!-- Memory List Section -->
        <h2 class="text-2xl font-bold text-gray-700 mb-6">Stored Memories (Read All)</h2>
        <div id="memories-list">
            <!-- Memories will be dynamically loaded here by the Firestore listener -->
            <div class="text-center p-8 bg-white rounded-xl shadow-md">
                <p class="text-gray-500">Loading memories...</p>
            </div>
        </div>
    </div>

</body>
</html>